<div class="layout-container flex h-full grow flex-col overflow-hidden">
    <div class="px-4 md:px-6 lg:px-8 flex flex-1 justify-center py-3 overflow-y-auto">
        <div class="layout-content-container flex flex-col max-w-[1400px] flex-1">
            <!-- Page Heading -->
            <!-- Confirmation Message -->
            <div *ngIf="confirmationMessage" class="p-2">
                <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30 text-green-500 text-sm">
                    {{ confirmationMessage }}
                </div>
            </div>
            <div class="flex flex-wrap justify-between gap-2 px-2 py-3">
                <div class="flex flex-col gap-1">
                    <h1 class="text-white text-2xl font-bold">Solicitar Turno</h1>
                    <p class="text-text-secondary text-sm">Reservá un espacio para el mantenimiento de tu moto en pocos
                        pasos.</p>
                </div>
            </div>

            <!-- No Motorcycles Warning -->
            <div *ngIf="!loadingMotos && motorcycles.length === 0"
                class="mx-4 mb-6 p-6 rounded-lg bg-yellow-500/10 border border-yellow-500/30 text-yellow-500">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-2xl">warning</span>
                    <div>
                        <h3 class="font-bold text-lg mb-1">No tienes motos registradas</h3>
                        <p class="text-sm mb-3">Antes de solicitar un turno, debes registrar al menos una motocicleta.
                        </p>
                        <a routerLink="/dashboard/moto"
                            class="inline-flex items-center gap-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg transition-all text-sm">
                            <span class="material-symbols-outlined text-lg">two_wheeler</span>
                            <span>Ir a Mis Motos</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 px-2 mb-10">
                <!-- Left Column: Steps -->
                <div class="lg:col-span-8 flex flex-col gap-4">
                    <!-- Step 1: Vehicle -->
                    <section class="flex flex-col gap-2">
                        <h3 class="text-white text-lg font-bold flex items-center gap-2">
                            <span
                                class="bg-surface-dark border border-border-dark text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">1</span>
                            Seleccioná tu vehículo
                        </h3>
                        <div class="bg-surface-dark rounded-lg p-4 border border-border-dark">
                            <label class="flex flex-col w-full">
                                <span class="text-text-secondary text-xs font-medium pb-1.5">Moto registrada</span>
                                <div class="relative">
                                    <select [value]="selectedMotorcycleId" (change)="selectMotorcycle($event)"
                                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-dark bg-[#111318] h-10 pl-3 pr-8 text-sm font-normal appearance-none cursor-pointer">
                                        <option *ngFor="let moto of motorcycles" [value]="moto.id">{{ moto.displayName
                                            }}</option>
                                        <option value="add">+ Agregar nueva moto</option>
                                    </select>
                                    <div
                                        class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-text-secondary">
                                        <span class="material-symbols-outlined text-lg">expand_more</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </section>
                    <!-- Step 2: Service -->
                    <section class="flex flex-col gap-2">
                        <h3 class="text-white text-lg font-bold flex items-center gap-2">
                            <span
                                class="bg-surface-dark border border-border-dark text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">2</span>
                            Tipo de Servicio
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div *ngFor="let service of services" (click)="selectService(service)"
                                [class]="isServiceSelected(service) ? 'bg-primary/10 border-2 border-primary' : 'bg-surface-dark border border-border-dark'"
                                class="rounded-lg p-3 flex flex-col gap-2 cursor-pointer relative overflow-hidden group hover:border-primary/50 transition-all">
                                <div *ngIf="isServiceSelected(service)" class="absolute top-2 right-2 text-primary">
                                    <span class="material-symbols-outlined filled text-lg">check_circle</span>
                                </div>
                                <div [class]="isServiceSelected(service) ? 'bg-primary/20 text-primary' : 'bg-[#292e38] text-white'"
                                    class="size-8 rounded-lg flex items-center justify-center shrink-0">
                                    <span class="material-symbols-outlined text-lg">{{ service.icon }}</span>
                                </div>
                                <div>
                                    <h4 class="text-white font-bold text-sm">{{ service.name }}</h4>
                                    <p class="text-text-secondary text-xs mt-0.5">{{ service.description }}</p>
                                </div>
                                <div class="mt-auto pt-1 flex items-center justify-between text-xs">
                                    <span class="text-white font-semibold">{{ getFormattedPrice(service.price) }}</span>
                                    <span class="text-text-secondary">{{ service.duration }}</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- Step 3: Date & Time -->
                    <section class="flex flex-col gap-2 py-6">
                        <h3 class="text-white text-lg font-bold flex items-center gap-2">
                            <span
                                class="bg-surface-dark border border-border-dark text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">3</span>
                            Fecha y Hora
                        </h3>
                        <div
                            class="bg-surface-dark rounded-lg border border-border-dark overflow-hidden flex flex-col md:flex-row">
                            <!-- Calendar -->
                            <div class="p-4 flex-1 border-b md:border-b-0 md:border-r border-border-dark">
                                <div class="flex items-center justify-between mb-3">
                                    <button (click)="previousMonth()" [disabled]="!canGoPreviousMonth()"
                                        class="p-1 rounded-full hover:bg-border-dark text-text-secondary hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
                                        <span class="material-symbols-outlined text-lg">chevron_left</span>
                                    </button>
                                    <span class="text-sm font-bold text-white">{{ monthName }}</span>
                                    <button (click)="nextMonth()"
                                        class="p-1 rounded-full hover:bg-border-dark text-text-secondary hover:text-white transition-colors">
                                        <span class="material-symbols-outlined text-lg">chevron_right</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-center text-xs mb-1">
                                    <div class="text-text-secondary font-medium">Do</div>
                                    <div class="text-text-secondary font-medium">Lu</div>
                                    <div class="text-text-secondary font-medium">Ma</div>
                                    <div class="text-text-secondary font-medium">Mi</div>
                                    <div class="text-text-secondary font-medium">Ju</div>
                                    <div class="text-text-secondary font-medium">Vi</div>
                                    <div class="text-text-secondary font-medium">Sa</div>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-center">
                                    <!-- Empty cells for padding -->
                                    <div *ngFor="let empty of emptyDays" class="h-8 w-8"></div>
                                    <!-- Calendar days -->
                                    <div *ngFor="let day of calendarDays"
                                        (click)="!isDayDisabled(day) && selectDate(day)"
                                        [class]="isDateSelected(day) ? 'bg-primary text-white font-bold shadow-lg shadow-primary/20' : isDayDisabled(day) ? 'text-text-secondary/50 cursor-not-allowed' : 'hover:bg-border-dark cursor-pointer text-white'"
                                        class="h-8 w-8 flex items-center justify-center rounded-full transition-colors text-xs">
                                        {{ day }}
                                    </div>
                                </div>
                            </div>
                            <!-- Time Slots -->
                            <div class="p-4 flex-1 bg-[#161920]">
                                <div class="mb-3">
                                    <h4 class="text-white font-medium text-sm mb-0.5">Horarios Disponibles</h4>
                                    <p class="text-text-secondary text-xs">{{ getSelectedDateText() }}</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto">
                                    <button *ngFor="let slot of availableTimeSlots" (click)="selectTimeSlot(slot)"
                                        [disabled]="!slot.available"
                                        [class]="isTimeSelected(slot.time) ? 'bg-primary text-white border-primary shadow-lg shadow-primary/20' : slot.available ? 'border-border-dark text-text-secondary hover:border-white hover:text-white' : 'border-border-dark text-text-secondary/50 cursor-not-allowed bg-background-dark/50 relative overflow-hidden'"
                                        class="py-1.5 px-3 rounded-lg border transition-all text-xs font-medium relative group">
                                        {{ slot.time }}
                                        <span *ngIf="!slot.available"
                                            class="absolute inset-0 flex items-center justify-center bg-gray-900/60">
                                            <span class="material-symbols-outlined text-gray-500 text-sm">block</span>
                                        </span>
                                    </button>
                                </div>
                                <div *ngIf="availableTimeSlots.length === 0"
                                    class="text-xs text-text-secondary text-center mt-4">
                                    Selecciona una fecha ver horarios.
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                <!-- Right Column: Summary -->
                <div class="lg:col-span-4">
                    <div class="flex flex-col gap-6 pt-8">
                        <div class="bg-surface-dark border border-border-dark rounded-xl p-6 shadow-xl">
                            <h3 class="text-xl font-bold text-white mb-6 pb-4 border-b border-border-dark">Resumen del
                                Turno</h3>
                            <div class="flex flex-col gap-4 mb-6">
                                <div class="flex gap-3 items-start">
                                    <div class="text-primary mt-0.5">
                                        <span class="material-symbols-outlined text-lg">two_wheeler</span>
                                    </div>
                                    <div>
                                        <p class="text-text-secondary text-xs uppercase tracking-wider font-bold">
                                            Vehículo</p>
                                        <p class="text-white font-medium">{{ selectedMotorcycle?.brand }} {{
                                            selectedMotorcycle?.model }}</p>
                                    </div>
                                </div>
                                <div class="flex gap-3 items-start">
                                    <div class="text-primary mt-0.5">
                                        <span class="material-symbols-outlined text-lg">build_circle</span>
                                    </div>
                                    <div>
                                        <p class="text-text-secondary text-xs uppercase tracking-wider font-bold">
                                            Servicio</p>
                                        <p class="text-white font-medium">{{ selectedService?.name || 'No seleccionado'
                                            }}</p>
                                    </div>
                                </div>
                                <div class="flex gap-3 items-start">
                                    <div class="text-primary mt-0.5">
                                        <span class="material-symbols-outlined text-lg">calendar_month</span>
                                    </div>
                                    <div>
                                        <p class="text-text-secondary text-xs uppercase tracking-wider font-bold">Fecha
                                            y Hora</p>
                                        <p class="text-white font-medium">{{ selectedDate ? 'Sáb ' + selectedDate + '
                                            Oct, ' + selectedTime : 'No seleccionado' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-[#111318] rounded-lg p-4 mb-6 border border-border-dark">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-text-secondary text-sm">Subtotal</span>
                                    <span class="text-white text-sm">{{ getFormattedPrice(getTotalPrice()) }}</span>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-text-secondary text-sm">Reserva</span>
                                    <span class="text-green-500 text-sm">Gratis</span>
                                </div>
                                <div class="h-px bg-border-dark my-2"></div>
                                <div class="flex justify-between items-center">
                                    <span class="text-white font-bold">Total Estimado</span>
                                    <span class="text-xl font-bold text-white">{{ getFormattedPrice(getTotalPrice())
                                        }}</span>
                                </div>
                            </div>
                            <button (click)="confirmAppointment()"
                                class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-lg transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2">
                                <span>Confirmar Turno</span>
                                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </button>
                            <p class="text-center text-text-secondary text-xs mt-4">
                                Al confirmar, aceptás nuestras políticas de cancelación.
                            </p>
                        </div>
                        <!-- Help Card -->
                        <div
                            class="bg-surface-dark/50 border border-border-dark rounded-xl p-4 flex gap-4 items-center">
                            <div class="rounded-full bg-background-dark p-2 text-text-secondary">
                                <span class="material-symbols-outlined">support_agent</span>
                            </div>
                            <div>
                                <p class="text-white text-sm font-medium">¿Necesitas ayuda?</p>
                                <a routerLink="/contacto" class="text-primary text-sm hover:underline">Contactar
                                    soporte</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>